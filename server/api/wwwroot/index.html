<!DOCTYPE html>
<html>
<body>
<div id="system"></div>
<div>My connectionId: <code id="myId">connecting...</code></div>
<div id="messages"></div>
<input id="msg" placeholder="Message" />
<button onclick="send()">Send</button>

<script type="module">
    import { StateleSSEClient } from 'https://cdn.jsdelivr.net/npm/statele-sse/dist/index.js'

    const sse = new StateleSSEClient("/sse");

    let myId = null;

    sse.listen(
        async (id) => {
            myId = id;
            document.getElementById("myId").textContent = id;

            const res = await fetch(`/messages?connectionId=${id}`);
            return await res.json();
        },
        (data) => {
            // If it's a poke payload
            if (data?.type === "poke") {
                alert(data.message);
                return;
            }
            if (data?.type === "system") {
                console.log("SYSTEM:", data.message);
                addSystemLine(data.message);
                return;
            }

            // Otherwise treat as messages list
            render(data);
        }
    );

    function render(messages) {
        document.getElementById("messages").innerHTML =
            messages.map(m => `<p>${m.content}</p>`).join("");
    }

    function addSystemLine(text) {
        const div = document.getElementById("system");
        div.innerHTML = `<p><i>${text}</i></p>` + div.innerHTML;
    }

    window.send = () => {
        fetch(`/send?message=${document.getElementById("msg").value}`, { method: "POST" });
        document.getElementById("msg").value = "";
    };
</script>

</body>
</html>